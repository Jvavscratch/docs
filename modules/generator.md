# Generator 模块

Generator模块负责将jvavscratch的中间表示转换为完整的Scratch项目文件(.sb3)。它处理所有与Scratch项目结构相关的任务，包括创建精灵、背景、块、变量等。

## 模块功能

Generator模块主要提供以下功能：

1. 将Scratch块表示转换为Scratch项目格式
2. 创建和配置精灵（Sprite）
3. 创建和配置背景（Background）
4. 管理变量、列表和广播消息
5. 生成完整的.sb3文件（实际上是一个ZIP压缩文件）

## API概述

### 核心API

#### `generateProject(blocks, options)`

生成完整的Scratch项目。

**参数：**
- `blocks`: Scratch块表示对象，通常从Core模块的`generateScratchBlocks`获取
- `options`: 生成选项
  - `name`: 项目名称（默认："Jvavscratch Project"）
  - `author`: 作者名称（默认："Anonymous"）
  - `description`: 项目描述（默认："Generated by jvavscratch"）
  - `version`: Scratch版本（默认："3.0.0"）
  - `sprites`: 精灵配置数组
  - `backgrounds`: 背景配置数组

**返回值：**
- 包含项目数据的对象，可以通过`saveProject`保存为.sb3文件

**示例：**
```javascript
const { generateProject } = require('jvavscratch/generator');
const projectData = generateProject(blocks, {
  name: 'My Project',
  author: 'John Doe'
});
```

#### `saveProject(projectData, filePath)`

将项目数据保存为.sb3文件。

**参数：**
- `projectData`: 项目数据对象，从`generateProject`获取
- `filePath`: 输出文件路径

**返回值：**
- Promise，解析为保存的文件路径

**示例：**
```javascript
const { saveProject } = require('jvavscratch/generator');
await saveProject(projectData, './output/project.sb3');
```

#### `createSprite(name, options)`

创建新的精灵配置。

**参数：**
- `name`: 精灵名称
- `options`: 精灵选项
  - `x`: x坐标（默认：0）
  - `y`: y坐标（默认：0）
  - `size`: 大小（默认：100）
  - `direction`: 方向（默认：90）
  - `visible`: 是否可见（默认：true）
  - `costumes`: 造型配置数组
  - `scripts`: 脚本数组

**返回值：**
- 精灵配置对象

**示例：**
```javascript
const { createSprite } = require('jvavscratch/generator');
const catSprite = createSprite('Cat', {
  x: 100,
  y: 0,
  size: 50
});
```

#### `createBackground(name, options)`

创建新的背景配置。

**参数：**
- `name`: 背景名称
- `options`: 背景选项
  - `costumes`: 造型配置数组
  - `scripts`: 脚本数组

**返回值：**
- 背景配置对象

**示例：**
```javascript
const { createBackground } = require('jvavscratch/generator');
const stageBackground = createBackground('Stage', {
  costumes: [{ name: 'Backdrop1', data: /* image data */ }]
});
```

### 工具API

#### `createVariable(name, type, isGlobal, initialValue)`

创建变量配置。

**参数：**
- `name`: 变量名称
- `type`: 变量类型（"number", "string", "boolean", "array"）
- `isGlobal`: 是否为全局变量
- `initialValue`: 初始值

**返回值：**
- 变量配置对象

**示例：**
```javascript
const { createVariable } = require('jvavscratch/generator');
const scoreVar = createVariable('score', 'number', true, 0);
```

#### `createList(name, isGlobal, initialItems)`

创建列表（数组）配置。

**参数：**
- `name`: 列表名称
- `isGlobal`: 是否为全局列表
- `initialItems`: 初始项目数组

**返回值：**
- 列表配置对象

**示例：**
```javascript
const { createList } = require('jvavscratch/generator');
const itemsList = createList('items', true, ['apple', 'banana']);
```

#### `createBroadcast(name)`

创建广播消息配置。

**参数：**
- `name`: 广播名称

**返回值：**
- 广播配置对象

**示例：**
```javascript
const { createBroadcast } = require('jvavscratch/generator');
const gameOverBroadcast = createBroadcast('game over');
```

## 项目结构

Generator模块生成的Scratch项目包含以下核心文件：

1. **project.json**: 项目主配置文件，包含所有精灵、变量、广播等信息
2. **sprites/**: 存放所有精灵资源的目录
   - 每个精灵有自己的子目录
   - 包含精灵配置和造型文件
3. **costumes/**: 存放背景造型的目录
4. **sounds/**: 存放音效的目录

## 精灵和背景配置

### 精灵配置

精灵配置包含以下主要属性：

```javascript
const spriteConfig = {
  name: 'Sprite1',  // 精灵名称
  variables: {},    // 精灵变量
  lists: {},        // 精灵列表
  broadcasts: {},   // 广播消息
  blocks: {},       // 代码块
  comments: {},     // 注释
  currentCostumeIndex: 0,  // 当前造型索引
  costumes: [],     // 造型列表
  sounds: [],       // 音效列表
  layerOrder: 1,    // 图层顺序
  x: 0,             // x坐标
  y: 0,             // y坐标
  size: 100,        // 大小
  direction: 90,    // 方向
  draggable: false, // 是否可拖拽
  rotationStyle: 'all around', // 旋转方式
  visible: true     // 是否可见
};
```

### 背景配置

背景配置包含以下主要属性：

```javascript
const backgroundConfig = {
  name: 'Stage',    // 背景名称
  variables: {},    // 背景变量
  lists: {},        // 背景列表
  broadcasts: {},   // 广播消息
  blocks: {},       // 代码块
  comments: {},     // 注释
  currentCostumeIndex: 0,  // 当前造型索引
  costumes: [],     // 造型列表
  sounds: [],       // 音效列表
  videoState: 'on', // 视频状态
  textToSpeechLanguage: null // 文本转语音语言
};
```

## 自定义资源

Generator模块允许添加自定义的精灵造型和音效：

### 添加造型

```javascript
const { generateProject, createSprite } = require('jvavscratch/generator');
const fs = require('fs');

// 读取图片文件
const imageData = fs.readFileSync('./custom-sprite.png', 'base64');

// 创建带有自定义造型的精灵
const customSprite = createSprite('CustomSprite', {
  costumes: [{
    name: 'costume1',
    data: imageData,
    md5: `custom-sprite.png.${md5(imageData)}.png`, // 生成MD5哈希
    dataFormat: 'png',
    rotationCenterX: 48,
    rotationCenterY: 50
  }]
});

// 生成项目
const project = generateProject(blocks, {
  sprites: [customSprite]
});
```

### 添加音效

```javascript
const { generateProject, createSprite } = require('jvavscratch/generator');
const fs = require('fs');

// 读取音效文件
const soundData = fs.readFileSync('./custom-sound.wav', 'base64');

// 创建带有自定义音效的精灵
const soundSprite = createSprite('SoundSprite', {
  sounds: [{
    name: 'sound1',
    data: soundData,
    md5: `custom-sound.wav.${md5(soundData)}.wav`, // 生成MD5哈希
    format: 'wav',
    rate: 44100,
    sampleCount: 10000
  }]
});
```

## 限制和注意事项

1. Scratch有一些固有的限制，如变量类型限制、循环深度限制等
2. 复杂的JavaScript数据结构可能无法完全转换为Scratch支持的形式
3. 自定义资源需要符合Scratch的格式要求，特别是图像大小和格式
4. 生成的项目可能需要在Scratch编辑器中进行一些手动调整